<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />  
  <title>Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ â€” Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù†Ø³Ù‚Ø©</title>
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a; --paper: #fdfbf7; --muted: #64748b; --accent: #b8862f;
      --ink: #1e293b; --radius: 20px; --shadow: 0 10px 30px rgba(0,0,0,0.3);
      --sans: 'Cairo', sans-serif; --serif: 'Amiri', serif;
    }
    .dark { --bg: #020617; --paper: #1e293b; --ink: #f1f5f9; --muted: #94a3b8; }

    body { margin: 0; background: var(--bg); font-family: var(--sans); color: var(--ink); transition: background 0.3s; }
    .app { display: flex; flex-direction: column; min-height: 100vh; }

    /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
    header.app-bar {
      padding: 12px 20px; display: flex; align-items: center; justify-content: space-between;
      background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.1); z-index: 1000;
    }
    .brand .title { font-size: 18px; font-weight: 800; color: #fff; margin: 0; }
    .brand .subtitle { font-size: 10px; color: var(--muted); }

    /* --- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© --- */
    .shell { flex: 1; display: flex; overflow: hidden; position: relative; }
    .reader-wrap { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 120px; scroll-behavior: smooth; touch-action: pan-y; }

    /* Desktop card-style (default) */
    .mushaf-card {
      background: var(--paper); border-radius: var(--radius); padding: 40px 25px;
      box-shadow: var(--shadow); max-width: 800px; margin: 20px auto; min-height: 80vh;
      direction: rtl; position: relative;
    }

    /* --- hint ØµØºÙŠØ± ÙŠØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„ØµÙØ­Ø© --- */
    .location-hint { font-size: 13px; color: var(--muted); text-align: center; margin-bottom: 8px; }

    /* --- ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø³ÙˆØ±Ø© ÙˆØ§Ù„Ø¨Ø³Ù…Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- */
    .surah-block { margin-top: 30px; margin-bottom: 20px; text-align: center; clear: both; display: block; width: 100%; }
    
    .surah-name-frame {
      display: inline-block;
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 8px 30px;
      font-family: var(--serif);
      font-size: 24px;
      font-weight: bold;
      color: var(--accent);
      background: rgba(184, 134, 47, 0.08);
      margin-bottom: 15px;
    }

    .basmalah-decorated {
      font-family: var(--serif);
      font-size: 28px;
      color: var(--ink);
      margin: 10px 0 25px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      opacity: 0.9;
    }
    .basmalah-decorated::before, .basmalah-decorated::after {
      content: "Û";
      color: var(--accent);
      font-size: 22px;
    }

    /* play button near surah title */
    .play-surah {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:40px;
      height:40px;
      border-radius:50%;
      background:var(--accent);
      color:#fff;
      border: none;
      font-size: 16px;
      cursor:pointer;
      box-shadow: 0 6px 14px rgba(0,0,0,0.25);
      transition: transform .12s;
      margin-left:8px;
    }
    .play-surah.small { width:34px; height:34px; font-size:14px; padding:0; }

    /* --- ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠ --- */
    .page-text { 
      font-family: var(--serif); 
      font-size: 26px; 
      line-height: 2.3; 
      text-align: justify; 
      text-align-last: center; 
      display: block;
    }

    .verse { cursor: pointer; padding: 8px 0; border-radius: 6px; transition: 0.2s; display: inline; }
    .verse:hover { background: rgba(184, 134, 47, 0.06); }
    /* Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª */
    .verse.marked-gold { background: rgba(184, 134, 47, 0.15); border-bottom: 2px solid #b8862f; }
    .verse.marked-green { background: rgba(16, 185, 129, 0.15); border-bottom: 2px solid #10b981; }
    .verse.marked-red { background: rgba(239, 68, 68, 0.15); border-bottom: 2px solid #ef4444; }

    .verse-num {
      font-family: var(--sans); font-size: 14px; color: var(--accent); font-weight: bold;
      margin: 0 6px; display: inline-flex; width: 30px; height: 30px;
      border: 1px solid var(--accent); border-radius: 50%; align-items: center; justify-content: center;
    }

    /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø§Ù„ÙÙ‡Ø±Ø³) --- */
    .sidebar {
      position: fixed; right: -100%; top: 0; bottom: 0; width: 85%; max-width: 320px;
      background: var(--bg); z-index: 2000; transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      padding: 20px; display: flex; flex-direction: column; box-shadow: -10px 0 30px rgba(0,0,0,0.5);
    }
    .sidebar.open { right: 0; }
    .toc { flex: 1; overflow-y: auto; margin-top: 20px; padding-right: 5px; }
    .toc a {
      display: flex; justify-content: space-between; padding: 14px;
      background: rgba(255,255,255,0.05); margin-bottom: 8px; border-radius: 12px;
      text-decoration: none; color: #fff; font-size: 14px; border: 1px solid rgba(255,255,255,0.05);
    }

    /* --- Ø§Ù„Ø²Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
    .btn { border: none; background: var(--accent); color: white; padding: 10px 20px; border-radius: 50px; font-weight: 700; cursor: pointer; }
    .btn-icon { background: rgba(255,255,255,0.1); color: white; width: 48px; height: 48px; border-radius: 50%; border: none; font-size: 20px; cursor: pointer; display:flex; align-items:center; justify-content:center; }

    /* --- Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ø§Ù„ØªÙØ³ÙŠØ± ÙˆØ§Ù„Ø¹Ù„Ø§Ù…Ø§Øª) --- */
    .tafsir-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; align-items: flex-end; justify-content: center; z-index: 3000; }
    .tafsir-panel { background: var(--paper); width: 100%; max-width: 600px; border-radius: 30px 30px 0 0; padding: 25px; max-height: 80vh; overflow-y: auto; }
    .mark-tools { display: flex; align-items: center; gap: 12px; margin: 15px 0; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 12px; }
    .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: 0.2s; }
    .choice-btn { background: #111; color: #fff; border: none; padding: 10px; border-radius: 10px; font-weight: bold; cursor: pointer; flex: 1; font-size: 13px; }

    /* --- Responsive: mobile layout (clean, full-bleed verses, organized) --- */
    @media (max-width: 767px) {
      .reader-wrap { padding: 10px; }

      /* make the card disappear into the page â€” verses become full-bleed & tidy */
      .mushaf-card {
        background: transparent;
        box-shadow: none;
        border-radius: 8px;
        padding: 6px 6px 40px 6px;
        margin: 0;
        min-height: auto;
        max-width: none;
      }

      .page-text {
        font-size: 20px;
        line-height: 2.1;
        text-align: right;
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }

      /* each verse becomes a neat block: comfortable padding, subtle background, rounded */
      .verse {
        display: block;
        padding: 12px 14px;
        background: rgba(255,255,255,0.02);
        border-radius: 12px;
        margin: 0; /* gap handled by grid */
        font-size: 20px;
      }

      .verse-num {
        float: left;
        margin-left: 8px;
        margin-right: 0;
      }

      /* smaller play button on mobile */
      .surah-name-frame .play-surah { width:34px; height:34px; font-size:14px; }
    }

    @media (min-width: 768px) {
      .sidebar { position: static; right: 0; width: 350px; margin: 15px; border-radius: 20px; }
      .tafsir-modal { align-items: center; padding: 20px; }
      .tafsir-panel { border-radius: 25px; }
    }
  </style>
</head>
<body class="dark">

<div class="app">
  <header class="app-bar">
    <div class="brand">
      <h1 class="title">Ø§Ù„Ù…ØµØ­Ù Ø§Ù„Ø´Ø±ÙŠÙ</h1>
      <div class="subtitle">ØªØµÙ…ÙŠÙ… Ø§Ù„Ù…ØµØ­Ù Ø§Ù„ÙˆØ±Ù‚ÙŠ</div>
    </div>
    <div style="display:flex; gap:8px; align-items:center;">
      <button class="btn-icon" id="toggleTheme">ğŸŒ“</button>
      <button class="btn-icon"><a href="a.html" style="text-decoration: none; color:inherit;">ğŸ§</a></button>

      <!-- Ø²Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø§Ù†ØªÙ‚Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ù‡ÙŠØ¯Ø± ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª -->
      <button class="btn" id="btnRandom" title="ÙØªØ­ ØµÙØ­Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©">ğŸ² Ø¹Ø´ÙˆØ§Ø¦ÙŠ</button>

      <button class="btn" id="openMenu">â˜° Ø§Ù„ÙÙ‡Ø±Ø³</button>
    </div>
  </header>

  <div class="shell">
    <main class="reader-wrap" id="readerWrap">
      <div class="mushaf-card" id="mushafCard">
        <div id="pageMeta" style="text-align: center; color: var(--muted); font-size: 13px; margin-bottom: 6px;">
          ØµÙØ­Ø© <span id="pageIdx">1</span>
        </div>
        <!-- Ù‡Ù†Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø³Ø·Ø± Ø§Ù„ØµØºÙŠØ± Ø§Ù„Ø°ÙŠ ÙŠØ³Ø£Ù„ØªÙ‡ -->
        <div id="locationHint" class="location-hint" aria-live="polite"></div>

        <article id="mushafContent" class="page-text">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</article>
      </div>
    </main>

    <aside class="sidebar" id="sidebar">
      <h2 style="color:#fff; margin-bottom:15px;">ÙÙ‡Ø±Ø³ Ø§Ù„Ø³ÙˆØ±</h2>
      <div class="toc" id="toc"></div>
      <button id="closeMenu" class="btn" style="margin-top:10px; width:100%">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙÙ‡Ø±Ø³</button>
    </aside>
  </div>
</div>

<!-- Ù…Ø´ØºÙ‘Ù„ ØµÙˆØªÙŠ ÙˆØ§Ø­Ø¯ Ù…Ø±ÙƒØ²ÙŠ Ù„Ù„Ø³ÙˆØ± -->
<audio id="surahAudio" preload="none" crossorigin="anonymous"></audio>

<div id="tafsirModal" class="tafsir-modal">
  <div class="tafsir-panel">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h3 id="tafsirTitle" style="margin:0; color:var(--accent);">Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø¢ÙŠØ©</h3>
      <button id="tafsirClose" style="border:none; padding:8px 15px; border-radius:8px; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
    <p id="tafsirMeta" style="color:var(--muted); font-size:14px; margin:10px 0;"></p>

    <div class="mark-tools">
      <span style="font-size:13px; font-weight:bold;">Ø­ÙØ¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø©:</span>
      <div class="color-dot" style="background:#b8862f" onclick="setMark('gold')"></div>
      <div class="color-dot" style="background:#10b981" onclick="setMark('green')"></div>
      <div class="color-dot" style="background:#ef4444" onclick="setMark('red')"></div>
      <button id="clearMarkBtn" style="margin-right:auto; background:none; border:1px solid #ccc; padding:4px 8px; border-radius:5px; cursor:pointer; font-size:11px;">Ø­Ø°Ù</button>
    </div>

    <div style="display:flex; gap:5px; margin-bottom:15px;" id="ksuButtons"></div>
    <div id="tafsirContent" style="background:rgba(0,0,0,0.03); padding:15px; border-radius:15px; line-height:1.8; font-size:17px; font-family:var(--serif);"></div>
  </div>
</div>

<script>
(function(){
  // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³ÙˆØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  const SURA_TABLE = [{n:1, s:'Ø§Ù„ÙØ§ØªØ­Ø©', p:1},{n:2, s:'Ø§Ù„Ø¨Ù‚Ø±Ø©', p:2},{n:3, s:'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†', p:50},{n:4, s:'Ø§Ù„Ù†Ø³Ø§Ø¡', p:77},{n:5, s:'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©', p:106},{n:6, s:'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…', p:128},{n:7, s:'Ø§Ù„Ø£Ø¹Ø±Ø§Ù', p:151},{n:8, s:'Ø§Ù„Ø£Ù†ÙØ§Ù„', p:177},{n:9, s:'Ø§Ù„ØªÙˆØ¨Ø©', p:187},{n:10, s:'ÙŠÙˆÙ†Ø³', p:208},{n:11, s:'Ù‡ÙˆØ¯', p:221},{n:12, s:'ÙŠÙˆØ³Ù', p:234},{n:13, s:'Ø§Ù„Ø±Ø¹Ø¯', p:246},{n:14, s:'Ø§Ø¨Ø±Ø§Ù‡ÙŠÙ…', p:249},{n:15, s:'Ø§Ù„Ø­Ø¬Ø±', p:255},{n:16, s:'Ø§Ù„Ù†Ø­Ù„', p:262},{n:17, s:'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡', p:282},{n:18, s:'Ø§Ù„ÙƒÙ‡Ù', p:293},{n:19, s:'Ù…Ø±ÙŠÙ…', p:305},{n:20, s:'Ø·Ù‡', p:312},{n:21, s:'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡', p:322},{n:22, s:'Ø§Ù„Ø­Ø¬', p:332},{n:23, s:'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†', p:342},{n:24, s:'Ø§Ù„Ù†ÙˆØ±', p:350},{n:25, s:'Ø§Ù„ÙØ±Ù‚Ø§Ù†', p:356},{n:26, s:'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡', p:361},{n:27, s:'Ø§Ù„Ù†Ù…Ù„', p:367},{n:28, s:'Ø§Ù„Ù‚ØµØµ', p:373},{n:29, s:'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª', p:381},{n:30, s:'Ø§Ù„Ø±ÙˆÙ…', p:386},{n:31, s:'Ù„Ù‚Ù…Ø§Ù†', p:392},{n:32, s:'Ø§Ù„Ø³Ø¬Ø¯Ø©', p:396},{n:33, s:'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨', p:399},{n:34, s:'Ø³Ø¨Ø£', p:404},{n:35, s:'ÙØ§Ø·Ø±', p:408},{n:36, s:'ÙŠØ³', p:412},{n:37, s:'Ø§Ù„ØµØ§ÙØ§Øª', p:417},{n:38, s:'Øµ', p:421},{n:39, s:'Ø§Ù„Ø²Ù…Ø±', p:425},{n:40, s:'ØºØ§ÙØ±', p:430},{n:41, s:'ÙØµÙ„Øª', p:434},{n:42, s:'Ø§Ù„Ø´ÙˆØ±Ù‰', p:438},{n:43, s:'Ø§Ù„Ø²Ø®Ø±Ù', p:442},{n:44, s:'Ø§Ù„Ø¯Ø®Ø§Ù†', p:445},{n:45, s:'Ø§Ù„Ø¬Ø§Ø«ÙŠØ©', p:448},{n:46, s:'Ø§Ù„Ø£Ø­Ù‚Ø§Ù', p:451},{n:47, s:'Ù…Ø­Ù…Ø¯', p:455},{n:48, s:'Ø§Ù„ÙØªØ­', p:458},{n:49, s:'Ø§Ù„Ø­Ø¬Ø±Ø§Øª', p:460},{n:50, s:'Ù‚', p:462},{n:51, s:'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª', p:464},{n:52, s:'Ø§Ù„Ø·ÙˆØ±', p:467},{n:53, s:'Ø§Ù„Ù†Ø¬Ù…', p:469},{n:54, s:'Ø§Ù„Ù‚Ù…Ø±', p:471},{n:55, s:'Ø§Ù„Ø±Ø­Ù…Ù†', p:473},{n:56, s:'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©', p:475},{n:57, s:'Ø§Ù„Ø­Ø¯ÙŠØ¯', p:477},{n:58, s:'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©', p:479},{n:59, s:'Ø§Ù„Ø­Ø´Ø±', p:481},{n:60, s:'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©', p:483},{n:61, s:'Ø§Ù„ØµÙ', p:484},{n:62, s:'Ø§Ù„Ø¬Ù…Ø¹Ø©', p:486},{n:63, s:'Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†', p:487},{n:64, s:'Ø§Ù„ØªØºØ§Ø¨Ù†', p:488},{n:65, s:'Ø§Ù„Ø·Ù„Ø§Ù‚', p:490},{n:66, s:'Ø§Ù„ØªØ­Ø±ÙŠÙ…', p:492},{n:67, s:'Ø§Ù„Ù…Ù„Ùƒ', p:493},{n:68, s:'Ø§Ù„Ù‚Ù„Ù…', p:495},{n:69, s:'Ø§Ù„Ø­Ø§Ù‚Ø©', p:497},{n:70, s:'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬', p:498},{n:71, s:'Ù†ÙˆØ­', p:499},{n:72, s:'Ø§Ù„Ø¬Ù†', p:500},{n:73, s:'Ø§Ù„Ù…Ø²Ù…Ù„', p:501},{n:74, s:'Ø§Ù„Ù…Ø¯Ø«Ø±', p:502},{n:75, s:'Ø§Ù„Ù‚ÙŠØ§Ù…Ø©', p:503},{n:76, s:'Ø§Ù„Ø¥Ù†Ø³Ø§Ù†', p:504},{n:77, s:'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª', p:505},{n:78, s:'Ø§Ù„Ù†Ø¨Ø£', p:506},{n:79, s:'Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª', p:507},{n:80, s:'Ø¹Ø¨Ø³', p:508},{n:81, s:'Ø§Ù„ØªÙƒÙˆÙŠØ±', p:509},{n:82, s:'Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±', p:510},{n:83, s:'Ø§Ù„Ù…Ø·ÙÙÙŠÙ†', p:511},{n:84, s:'Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚', p:512},{n:85, s:'Ø§Ù„Ø¨Ø±ÙˆØ¬', p:513},{n:86, s:'Ø§Ù„Ø·Ø§Ø±Ù‚', p:514},{n:87, s:'Ø§Ù„Ø£Ø¹Ù„Ù‰', p:515},{n:88, s:'Ø§Ù„ØºØ§Ø´ÙŠØ©', p:516},{n:89, s:'Ø§Ù„ÙØ¬Ø±', p:517},{n:90, s:'Ø§Ù„Ø¨Ù„Ø¯', p:518},{n:91, s:'Ø§Ù„Ø´Ù…Ø³', p:519},{n:92, s:'Ø§Ù„Ù„ÙŠÙ„', p:520},{n:93, s:'Ø§Ù„Ø¶Ø­Ù‰', p:521},{n:94, s:'Ø§Ù„Ø´Ø±Ø­', p:522},{n:95, s:'Ø§Ù„ØªÙŠÙ†', p:523},{n:96, s:'Ø§Ù„Ø¹Ù„Ù‚', p:524},{n:97, s:'Ø§Ù„Ù‚Ø¯Ø±', p:525},{n:98, s:'Ø§Ù„Ø¨ÙŠÙ†Ø©', p:526},{n:99, s:'Ø§Ù„Ø²Ù„Ø²Ù„Ø©', p:527},{n:100, s:'Ø§Ù„Ø¹Ğ°Ğ´ÙŠØ§Øª', p:528},{n:101, s:'Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©', p:529},{n:102, s:'Ø§Ù„ØªÙƒØ§Ø«Ø±', p:530},{n:103, s:'Ø§Ù„Ø¹ØµØ±', p:531},{n:104, s:'Ø§Ù„Ù‡Ù…Ø²Ø©', p:532},{n:105, s:'Ø§Ù„ÙÙŠÙ„', p:533},{n:106, s:'Ù‚Ø±ÙŠØ´', p:534},{n:107, s:'Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†', p:535},{n:108, s:'Ø§Ù„ÙƒÙˆØ«Ø±', p:536},{n:109, s:'Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†', p:537},{n:110, s:'Ø§Ù„Ù†ØµØ±', p:538},{n:111, s:'Ø§Ù„Ù…Ø³Ø¯', p:539},{n:112, s:'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ', p:540},{n:113, s:'Ø§Ù„ÙÙ„Ù‚', p:541},{n:114, s:'Ø§Ù„Ù†Ø§Ø³', p:542}];

  let currentPage = Number(localStorage.getItem('mushaf_page')) || 1;
  let currentVerse = null;
  let bookmarks = JSON.parse(localStorage.getItem('mushaf_bookmarks')) || {};

  // Ù…Ø´ØºÙ‘Ù„ Ø§Ù„ØµÙˆØª ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·
  const surahAudio = document.getElementById('surahAudio');
  let activePlayButton = null;
  let activeSurahPlaying = null;

  // MP3Quran server8 format: pad to 3 digits
  function surahAudioUrl(surahNumber) {
    const idx = String(Number(surahNumber)).padStart(3, '0');
    return `https://server8.mp3quran.net/afs/${idx}.mp3`;
  }

  async function loadPage(p) {
    if (p < 1 || p > 604) return;
    currentPage = p;
    localStorage.setItem('mushaf_page', p);
    const content = document.getElementById('mushafContent');
    content.innerHTML = '<div style="text-align:center; padding:50px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...</div>';
    document.getElementById('locationHint').textContent = '';
    
    try {
      // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¹Ø«Ù…Ø§Ù†ÙŠ Ù„Ø¬ÙˆØ¯Ø© Ø§Ù„Ù†Øµ
      const res = await fetch(`https://api.alquran.cloud/v1/page/${p}/quran-uthmani`);
      const data = await res.json();
      const ayahs = data.data.ayahs;
      
      document.getElementById('pageIdx').textContent = p;
      
      // ---- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„Ø¸Ø§Ù‡Ø±Ø© ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ ----
      if (ayahs && ayahs.length) {
        const surahStarts = ayahs.filter(a => a.numberInSurah === 1).map(a => a.surah.name);
        const visibleSurah = surahStarts.length ? surahStarts[0] : ayahs[0].surah.name;
        document.getElementById('locationHint').textContent = `Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø³ÙˆØ±Ø© ${visibleSurah} â€” ØµÙØ­Ø© ${p}`;
      }
      
      let htmlOutput = "";
      
      const basmalahStr = "Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„Ù‘ÙÙ‡Ù Ù±Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù";

      ayahs.forEach(a => {
        let text = a.text;
        
        if (a.numberInSurah === 1) {
          // Ø§Ø³Ù… Ø§Ù„Ø³ÙˆØ±Ø© + Ø²Ø± ØªØ´ØºÙŠÙ„
          htmlOutput += `
            <div class="surah-block">
              <div class="surah-name-frame">
                <span>Ø³ÙˆØ±Ø© ${a.surah.name}</span>
                <button class="play-surah small" data-surah="${a.surah.number}" aria-label="ØªØ´ØºÙŠÙ„ Ø³ÙˆØ±Ø© ${a.surah.name}">ğŸ”Š</button>
              </div>
            </div>
          `;

          if (a.surah.number !== 1 && a.surah.number !== 9) {
            htmlOutput += `
              <div class="basmalah-decorated">Ø¨ÙØ³Ù’Ù…Ù Ù±Ù„Ù„Ù‘ÙÙ‡Ù Ù±Ù„Ø±Ù‘ÙØ­Ù’Ù…ÙÙ°Ù†Ù Ù±Ù„Ø±Ù‘ÙØ­ÙÙŠÙ…Ù</div>
            `;
            
            if (text.startsWith(basmalahStr)) {
              text = text.replace(basmalahStr, "").trim();
            }
          }
        }
        
        htmlOutput += `
          <span class="verse" 
                data-surah="${a.surah.number}" 
                data-ayah="${a.numberInSurah}" 
                data-sname="${a.surah.name}">
            ${text} <span class="verse-num">${a.numberInSurah}</span>
          </span>
        `;
      });
      
      content.innerHTML = htmlOutput;
      applyMarksToUI();
      document.querySelector('.reader-wrap').scrollTop = 0;
      
    } catch(e) { 
      content.innerHTML = '<div style="text-align:center; color:red">ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</div>'; 
      document.getElementById('locationHint').textContent = '';
    }
  }

  // --- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª ---
  function applyMarksToUI() {
    document.querySelectorAll('.verse').forEach(v => {
      const key = `${v.dataset.surah}_${v.dataset.ayah}`;
      v.classList.remove('marked-gold', 'marked-green', 'marked-red');
      if (bookmarks[key]) v.classList.add(`marked-${bookmarks[key]}`);
    });
  }

  window.setMark = (color) => {
    if(!currentVerse) return;
    const key = `${currentVerse.surah}_${currentVerse.ayah}`;
    bookmarks[key] = color;
    localStorage.setItem('mushaf_bookmarks', JSON.stringify(bookmarks));
    applyMarksToUI();
    document.getElementById('tafsirModal').style.display = 'none';
  };

  document.getElementById('clearMarkBtn').onclick = () => {
    if(!currentVerse) return;
    const key = `${currentVerse.surah}_${currentVerse.ayah}`;
    delete bookmarks[key];
    localStorage.setItem('mushaf_bookmarks', JSON.stringify(bookmarks));
    applyMarksToUI();
    document.getElementById('tafsirModal').style.display = 'none';
  };

  // --- Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ ---
  window.goToPage = (p) => {
    loadPage(p);
    document.getElementById('sidebar').classList.remove('open');
  };

  document.getElementById('mushafContent').addEventListener('click', e => {
    const v = e.target.closest('.verse');
    if(!v) return;
    currentVerse = v.dataset;
    
    document.getElementById('tafsirTitle').textContent = `Ø³ÙˆØ±Ø© ${v.dataset.sname}`;
    document.getElementById('tafsirMeta').textContent = `Ø§Ù„Ø¢ÙŠØ© ${v.dataset.ayah}`;
    document.getElementById('tafsirContent').innerHTML = "Ø§Ø®ØªØ± ØªÙØ³ÙŠØ±Ø§Ù‹ Ù„Ù„Ù‚Ø±Ø§Ø¡Ø©...";
    
    const ksu = document.getElementById('ksuButtons');
    ksu.innerHTML = [
      {id:'saadi', l:'Ø§Ù„Ø³Ø¹Ø¯ÙŠ'}, {id:'katheer', l:'Ø§Ø¨Ù† ÙƒØ«ÙŠØ±'}, {id:'qortobi', l:'Ø§Ù„Ù‚Ø±Ø·Ø¨ÙŠ'}
    ].map(t => `
      <button class="choice-btn" onclick="window.open('https://quran.ksu.edu.sa/tafseer/${t.id}/sura${v.dataset.surah}-aya${v.dataset.ayah}.html')">
        ${t.l}
      </button>
    `).join('');
    
    fetch(`https://api-quran.com/api?type=tafser2&surah=${v.dataset.surah}&ayah=${v.dataset.ayah}`)
      .then(r => r.json())
      .then(d => {
         document.getElementById('tafsirContent').innerHTML = d.result || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªÙØ³ÙŠØ± Ù…ØªØ§Ø­";
      }).catch(() => {
         document.getElementById('tafsirContent').innerHTML = "ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙØ§Ø³ÙŠØ± Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© Ø£Ø¹Ù„Ø§Ù‡";
      });

    document.getElementById('tafsirModal').style.display = 'flex';
  });

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„ØµØºÙŠØ±Ø©
  document.getElementById('openMenu').onclick = () => document.getElementById('sidebar').classList.add('open');
  document.getElementById('closeMenu').onclick = () => document.getElementById('sidebar').classList.remove('open');
  document.getElementById('tafsirClose').onclick = () => document.getElementById('tafsirModal').style.display = 'none';
  document.getElementById('toggleTheme').onclick = () => document.body.classList.toggle('dark');

  // Ø²Ø± Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰
  document.getElementById('btnRandom').onclick = () => loadPage(Math.floor(Math.random() * 604) + 1);

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙÙ‡Ø±Ø³
  const toc = document.getElementById('toc');
  toc.innerHTML = SURA_TABLE.map(s => `
    <a href="#" onclick="event.preventDefault(); window.goToPage(${s.p})">
      <span>${s.n}. ${s.s}</span>
      <span style="opacity:0.6">Øµ ${s.p}</span>
    </a>
  `).join('');

  // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
  loadPage(currentPage);

  // ==========================
  // ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù ØµÙˆØª Ø§Ù„Ø³ÙˆØ±Ø© (event delegation Ù„Ù„Ø²Ø±)
  // ==========================
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.play-surah');
    if (!btn) return;
    const surahNum = btn.dataset.surah;
    if (!surahNum) return;

    // Ø¥Ø°Ø§ Ù†ÙØ³ Ø§Ù„Ø³ÙˆØ±Ø© ØªØ¹Ù…Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹
    if (activeSurahPlaying === surahNum) {
      if (surahAudio.paused) {
        surahAudio.play();
        btn.textContent = 'â¸';
      } else {
        surahAudio.pause();
        btn.textContent = 'ğŸ”Š';
      }
      return;
    }

    // Ø¥ÙŠÙ‚Ø§Ù Ø£ÙŠ ØªØ´ØºÙŠÙ„ Ø³Ø§Ø¨Ù‚ ÙˆØªØ­Ø¯ÙŠØ« Ø£ÙŠ Ø²Ø± Ø³Ø§Ø¨Ù‚
    if (activePlayButton && activePlayButton !== btn) {
      activePlayButton.textContent = 'ğŸ”Š';
    }
    activePlayButton = btn;
    activeSurahPlaying = surahNum;

    // Ø¶Ø¹ Ù…ØµØ¯Ø± Ø§Ù„ØµÙˆØª Ø«Ù… Ø´ØºÙ„Ù‡
    const url = surahAudioUrl(surahNum);
    surahAudio.src = url;
    surahAudio.currentTime = 0;
    surahAudio.play().then(() => {
      // ØªØ¨Ø¯ÙŠÙ„ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø²Ø± Ù„Ù„Ù…Ø¤Ø´Ø± Ø¥Ù„Ù‰ Ø¥ÙŠÙ‚Ø§Ù
      btn.textContent = 'â¸';
    }).catch(err => {
      // ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ â€” Ù†Ø¹ÙŠØ¯ Ø£ÙŠÙ‚ÙˆÙ†Ø© ÙˆÙ†Ø¸Ù‡Ø± Ø±Ø³Ø§Ù„Ø© Ø®ÙÙŠÙØ©
      console.warn('Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:', err);
      btn.textContent = 'ğŸ”Š';
      activeSurahPlaying = null;
      alert('ØªØ¹Ø°Ù‘Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª â€” ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆÙ…ØµØ¯Ø± Ø§Ù„ØµÙˆØª.');
    });
  });

  // Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙˆØª Ù†Ø¹ÙŠØ¯ Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
  surahAudio.addEventListener('ended', () => {
    if (activePlayButton) activePlayButton.textContent = 'ğŸ”Š';
    activeSurahPlaying = null;
  });
  surahAudio.addEventListener('pause', () => {
    if (activePlayButton) activePlayButton.textContent = 'ğŸ”Š';
  });

  // ==========================
  // Ø¯Ø¹Ù… Ø§Ù„Ø³Ø­Ø¨ Ø¨Ø§Ù„Ù„Ù…Ø³ ÙˆØ§Ù„ÙØ£Ø±Ø© (Swipe navigation)
  // ==========================
  const reader = document.getElementById('readerWrap');

  let startX = 0, startY = 0, isPointerDown = false;

  function handleSwipeEnd(dx, dy) {
    const absX = Math.abs(dx), absY = Math.abs(dy);
    const threshold = 60; // Ø¨ÙƒØ³Ù„ Ù„Ø§Ø²Ù… Ù„ØªØ­Ø¯ÙŠØ¯ Ø³Ø­Ø¨ Ù…Ù‚ØµÙˆØ¯
    if (absX > threshold && absX > absY) {
      if (dx < 0) {
        // Ø³Ø­Ø¨ Ù„Ù„ÙŠØ³Ø§Ø± -> ØµÙØ­Ø© ØªØ§Ù„ÙŠØ©
        loadPage(currentPage + 1);
      } else {
        // Ø³Ø­Ø¨ Ù„Ù„ÙŠÙ…ÙŠÙ† -> ØµÙØ­Ø© Ø³Ø§Ø¨Ù‚Ø©
        loadPage(currentPage - 1);
      }
    }
  }

  // Touch events
  reader.addEventListener('touchstart', (ev) => {
    if (!ev.touches || ev.touches.length === 0) return;
    const t = ev.touches[0];
    startX = t.clientX;
    startY = t.clientY;
    isPointerDown = true;
  }, {passive: true});

  reader.addEventListener('touchend', (ev) => {
    if (!isPointerDown) return;
    isPointerDown = false;
    const t = (ev.changedTouches && ev.changedTouches[0]) || null;
    if (!t) return;
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    handleSwipeEnd(dx, dy);
  });

  // Mouse drag support (desktop)
  let mouseDown = false, mouseStartX = 0, mouseStartY = 0;

  reader.addEventListener('mousedown', (e) => {
    if (e.button !== 0) return;
    mouseDown = true;
    mouseStartX = e.clientX;
    mouseStartY = e.clientY;
    document.body.style.userSelect = 'none';
  });

  document.addEventListener('mouseup', (e) => {
    if (!mouseDown) return;
    mouseDown = false;
    document.body.style.userSelect = '';
    const dx = e.clientX - mouseStartX;
    const dy = e.clientY - mouseStartY;
    handleSwipeEnd(dx, dy);
  });

  // Ø¯Ø¹Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
  document.addEventListener('keydown', (e) => {
    if (e.key === 'ArrowLeft') loadPage(currentPage - 1);
    if (e.key === 'ArrowRight') loadPage(currentPage + 1);
    if (e.key === 'r' || e.key === 'R') loadPage(Math.floor(Math.random() * 604) + 1);
  });

})();
</script>
</body>
</html>
